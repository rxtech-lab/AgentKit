name: Swift Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-macos:
    name: Build and Test (macOS)
    runs-on: macos-26

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Create .env file from secret
        run: echo "${{ secrets.ENV_B64 }}" | base64 --decode > .env

      - name: Validate .env file
        run: |
          if [ ! -s .env ]; then
            echo "Error: .env file is empty or does not exist"
            exit 1
          fi
          line_count=$(wc -l < .env)
          if [ "$line_count" -lt 2 ]; then
            echo "Error: .env file has only $line_count lines, expected at least 2"
            exit 1
          fi
          echo "âœ“ .env file validated: $line_count lines"

      - name: Build and Test with Xcode
        run: swift test --enable-code-coverage --no-parallel
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE_URL: https://openrouter.ai/api/v1
          OPENAI_MODEL: google/gemini-2.5-flash-lite

      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v5
        with:
          files: ./*.lcov
          fail_ci_if_error: false

  build-ios:
    name: Build (iOS)
    runs-on: macos-26

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Build for iOS Simulator
        run: |
          xcodebuild build \
            -scheme AgentKit \
            -destination 'generic/platform=iOS Simulator' \
            -skipPackagePluginValidation \
            | tail -n 20
